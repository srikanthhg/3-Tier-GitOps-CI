name: release tags
on:
  workflow_dispatch:

jobs:
  release_tag:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch latest matching release tag
        id: find_tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          OWNER="srikanthhg"
          REPO="3-Tier-GitOps-CI"
          PATTERN='^1\.0\.[0-9]+-[a-f0-9]{7}$'
          url="https://api.github.com/repos/${OWNER}/${REPO}/releases?per_page=100"

          matched_tag=""

          while [ -n "$url" ] && [ -z "$matched_tag" ]; do
            echo "Fetching: $url"

            response=$(curl -sSL -i \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$url")

            # Extract latest matching tag from body
            tag=$(echo "$response" \
              | sed -n '/^\r$/,$p' \
              | jq -r '.[].tag_name // empty' \
              | grep -E "$PATTERN" \
              | head -n 1)

            if [ -n "$tag" ]; then
              matched_tag="$tag"
              break
            fi

            # Get next page URL from Link header
            url=$(echo "$response" \
              | grep -i '^Link:' \
              | tr ',' '\n' \
              | grep 'rel="next"' \
              | sed -E 's/.*<([^>]+)>.*/\1/' \
              | head -1)
          done

          if [ -z "$matched_tag" ]; then
            echo "No matching tag found." >&2
            exit 1
          fi

          echo "Latest matching tag: $matched_tag"

          # Set GitHub Action output
          echo "tag=$matched_tag" >> "$GITHUB_OUTPUT"

# name:  release tags
# on:
#   workflow_dispatch:
# jobs:
#   release_tag:
#    runs-on: ubuntu-latest
#    steps:
#    - name: Fetch matching release tags (all pages)
#      env:
#        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#      run: |
#         OWNER="srikanthhg"
#         REPO="3-Tier-GitOps-CI"
#         PATTERN='^1\.0\.[0-9]+-[a-f0-9]{7}$'
#         url="https://api.github.com/repos/${OWNER}/${REPO}/releases"

#         while [ -n "$url" ]; do
#           response=$(mktemp)
#           header=$(mktemp)

#           curl -sSL \
#             -D "$header" \
#             -H "Accept: application/vnd.github+json" \
#             -H "Authorization: Bearer ${GITHUB_TOKEN}" \
#             -H "X-GitHub-Api-Version: 2022-11-28" \
#             "$url" -o "$response"

#           # Process each tag one-by-one; exit on first match
#           while IFS= read -r tag; do
#             if [[ $tag =~ $PATTERN ]]; then
#               echo "$tag"
#               rm -f "$response" "$header"
#               exit 0
#             fi
#           done < <(jq -r '.[].tag_name // empty' "$response")

#           # Get next page
#           url=$(grep -i '^Link:' "$header" | tr ',' '\n' | grep 'rel="next"' | sed -E 's/.*<([^>]+)>.*/\1/' | head -1)

#           rm - f "$response" "$header"
#         done

#         # If we reach here, no match was found
#         echo "No matching tag found." >&2
#         exit 1
    #  run: |
        # Paste the above script into a file or inline
        # bash << 'EOF'
        # set -eo pipefail
        # OWNER="srikanthhg"
        # REPO="3-Tier-GitOps-CI"
        # TOKEN="${GITHUB_TOKEN}"
        # PATTERN='^1\.0\.[0-9]+-[a-f0-9]{7}$'
        # url="https://api.github.com/repos/${OWNER}/${REPO}/releases"

        # while [ -n "$url" ]; do
        #   response=$(mktemp)
        #   header=$(mktemp)
        #   curl -sSL -D "$header" -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${TOKEN}" -H "X-GitHub-Api-Version: 2022-11-28" "$url" -o "$response"
          
        #   jq -r '.[].tag_name' "$response" | grep -E "$PATTERN"
          
        #   url=$(grep -i '^Link:' "$header" | tr ',' '\n' | grep 'rel="next"' | sed -E 's/.*<([^>]+)>.*/\1/' | head -1)
        #   rm -f "$response" "$header"
        # done
        # EOF
